`nftables` (Netfilter tables) — це сучасний фреймворк для фільтрації та класифікації мережевих пакетів у ядрі Linux, який прийшов на зміну `iptables`, `ip6tables`, `arptables` та `ebtables`. Він надає більш простий, узгоджений та продуктивний спосіб керування правилами брандмауера через єдину утиліту `nft`.

Основна перевага `nftables` — це значно спрощений синтаксис, краща продуктивність та більш гнучка структура.

### **Джерела інформації**
Як і `iptables`, `nft` взаємодіє безпосередньо з підсистемою Netfilter в ядрі Linux. Правила зберігаються в ядрі.
Для збереження правил між перезавантаженнями системи, конфігурація зазвичай зберігається у файлі `/etc/nftables.conf`. Цей файл завантажується автоматично при старті сервісу `nftables`.

---

### **Основні концепції**

#### 1. Таблиці (Tables)
Таблиці є контейнерами для ланцюжків. На відміну від `iptables`, де таблиці були жорстко визначені (`filter`, `nat`, `mangle`), в `nftables` ви можете створювати власні таблиці з будь-якими іменами.

#### 2. Сімейства адрес (Address Families)
При створенні таблиці ви вказуєте сімейство протоколів, для яких вона буде працювати.
*   `ip`: для IPv4.
*   `ip6`: для IPv6.
*   `inet`: для IPv4 та IPv6 (дозволяє створювати єдині правила).
*   `arp`: для ARP.
*   `bridge`: для трафіку на рівні моста.
*   `netdev`: для вхідного трафіку на рівні мережевого пристрою.

#### 3. Ланцюжки (Chains)
Ланцюжки містять правила. Існують два типи ланцюжків:
*   **Базові (Base chains):** Прив'язані до хуків Netfilter (наприклад, `input`, `forward`, `output`).
*   **Звичайні (Regular chains):** Використостовуються для кращої організації правил. Можна переходити на них з інших ланцюжків.

#### 4. Правила (Rules)
Правила визначають умови для пакетів та дії, які потрібно виконати (`accept`, `drop`, `reject`). Синтаксис правил став набагато більш інтуїтивним.

---

### **Базовий синтаксис**

```bash
sudo nft <команда>
```
Команди `nft` є атомарними. Це означає, що набір правил застосовується повністю, або не застосовується взагалі, що запобігає помилкам конфігурації.

---

### **Основні команди**

| Команда | Опис |
| :--- | :--- |
| `sudo nft list ruleset` | Показати повний набір правил (всі таблиці, ланцюжки, правила). |
| `sudo nft list table <сімейство> <таблиця>` | Показати вміст конкретної таблиці. |
| `sudo nft add table <сімейство> <таблиця>` | Створити нову таблицю. |
| `sudo nft add chain <сімейство> <таблиця> <ланцюжок> { type <тип> hook <хук> priority <пріоритет>; }` | Створити новий базовий ланцюжок. |
| `sudo nft add rule <сімейство> <таблиця> <ланцюжок> <правило>` | Додати правило. |
| `sudo nft delete rule <сімейство> <таблиця> <ланцюжок> handle <хендл>` | Видалити правило за його унікальним ідентифікатором (handle). |
| `sudo nft flush ruleset` | Очистити весь набір правил. |
| `sudo nft -f /etc/nftables.conf` | Завантажити правила з файлу. |

---

### **Приклади використання**

1.  **Створення базової структури (таблиця та ланцюжки):**
    ```bash
    # Очистити всі існуючі правила
    sudo nft flush ruleset

    # Створити таблицю 'filter' для IPv4 та IPv6
    sudo nft add table inet filter

    # Створити ланцюжки INPUT, FORWARD, OUTPUT
    sudo nft add chain inet filter input { type filter hook input priority 0; policy drop; }
    sudo nft add chain inet filter forward { type filter hook forward priority 0; policy drop; }
    sudo nft add chain inet filter output { type filter hook output priority 0; policy accept; }
    ```
    *Тут ми створюємо стандартну структуру з політикою "забороняти все, що не дозволено" для вхідного трафіку.*

2.  **Дозволити трафік для вже встановлених з'єднань та loopback:**
    ```bash
    # Дозволити встановлені та пов'язані з'єднання
    sudo nft add rule inet filter input ct state established,related accept

    # Дозволити трафік на loopback-інтерфейсі
    sudo nft add rule inet filter input iifname lo accept
    ```

3.  **Дозволити SSH, HTTP та HTTPS:**
    Синтаксис дозволяє вказувати кілька портів в одному правилі.
    ```bash
    sudo nft add rule inet filter input tcp dport { 22, 80, 443 } accept
    ```

4.  **Дозволити трафік з певної IP-адреси:**
    ```bash
    sudo nft add rule inet filter input ip saddr 192.168.1.100 accept
    ```

5.  **Переглянути правила з їхніми `handle`:**
    Щоб видалити правило, потрібно знати його `handle`.
    ```bash
    sudo nft --handle list chain inet filter input
    ```
    Вивід буде виглядати приблизно так:
    ```
    table inet filter {
      chain input { # handle 1
        ...
        tcp dport { 22, 80, 443 } accept # handle 4
        ...
      }
    }
    ```

6.  **Видалити правило:**
    Використовуємо `handle` з попередньої команди.
    ```bash
    sudo nft delete rule inet filter input handle 4
    ```

7.  **Збереження правил:**
    Після налаштування правил, збережіть їх у файл.
    ```bash
    sudo nft list ruleset > /etc/nftables.conf
    ```
    Або на системах з `systemd`:
    ```bash
    sudo systemctl enable nftables.service
    ```
    Це налаштує автоматичне завантаження правил з `/etc/nftables.conf` при старті системи.
