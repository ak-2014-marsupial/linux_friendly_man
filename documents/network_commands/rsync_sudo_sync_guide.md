# Практичний посібник: Синхронізація папок з rsync та sudo

`rsync` — це потужна утиліта для синхронізації файлів та директорій між локальними та віддаленими системами. Цей посібник демонструє, як синхронізувати директорію, коли для доступу на віддаленому хості потрібні права адміністратора (`sudo`).

## Сценарій

**Завдання:** Синхронізувати вміст папки `/tmp` з **Хоста А** (джерело) до папки `/tmp` на **Хості Б** (призначення).

**Умови:**
1.  На **Хості А** є права `sudo` для читання всіх файлів у `/tmp`.
2.  На **Хості Б** є SSH-доступ для користувача, який має права `sudo` для запису в `/tmp`.

## Крок 1: Базова команда синхронізації

Ця команда копіює файли з джерела до призначення, оновлюючи ті, що змінилися. Вона виконується на **Хості А**.

```bash
sudo rsync -avz --progress -h --rsync-path="sudo rsync" /tmp/ user@hostB:/tmp
```

### Пояснення параметрів

| Параметр                | Опис                                                                                                                                                                         |
| ----------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `sudo`                  | Підвищує права на локальному хості (А) для читання всіх файлів.                                                                                                                |
| `-a` (archive)          | Режим архівування: рекурсивно копіює, зберігаючи права доступу, власників, час модифікації та символічні посилання.                                                              |
| `-v` (verbose)          | Показує детальний список файлів, що передаються.                                                                                                                               |
| `-z` (compress)         | Стискає дані під час передачі для прискорення.                                                                                                                                |
| `--progress`            | Показує прогрес передачі для кожного файлу.                                                                                                                                  |
| `-h` (human-readable)   | Виводить розміри файлів у зручному для читання форматі (K, M, G).                                                                                                              |
| `--rsync-path="sudo rsync"` | **Ключовий параметр.** Наказує `rsync` на віддаленому хості (Б) запускатися через `sudo`, щоб отримати необхідні права для запису.                                               |
| `/tmp/`                 | Джерело. **Слеш в кінці** означає копіювати *вміст* папки, а не саму папку.                                                                                                    |
| `user@hostB:/tmp`       | Призначення: `[користувач]@[хост]:[шлях]`.                                                                                                                                      |

## Крок 2: Ключові концепції rsync

### Важливість слеша (`/`) в кінці шляху

Наявність або відсутність слеша в кінці шляху джерела кардинально змінює поведінку `rsync`.

- **Зі слешем:** `rsync ... /source/ ... /dest/`
  Копіює **вміст** папки `source` безпосередньо в папку `dest`.
  *Результат:* `/dest/file1`, `/dest/file2`

- **Без слеша:** `rsync ... /source ... /dest/`
  Копіює **саму папку** `source` всередину папки `dest`.
  *Результат:* `/dest/source/file1`, `/dest/source/file2`

### "Push" та "Pull" синхронізація

- **Push (відправити дані):** Локальна машина → Віддалена машина. Це те, що ми робили вище.
  ```bash
  # Відправляємо /var/log на сервер
  rsync -a /var/log/ user@hostB:/backup/logs
  ```

- **Pull (забрати дані):** Віддалена машина → Локальна машина. Просто поміняйте місцями джерело і призначення.
  ```bash
  # Забираємо логи з сервера до себе в /tmp
  rsync -a user@hostB:/var/log/ /tmp/logs
  ```

### Виключення файлів та директорій (`--exclude`)

Дуже часто потрібно виключити певні файли або папки (наприклад, кеш, логи, тимчасові файли).

```bash
rsync -avz --exclude='*.log' --exclude='cache/' /path/to/source/ user@hostB:/path/to/dest/
```
- `--exclude='*.log'` — виключає всі файли, що закінчуються на `.log`.
- `--exclude='cache/'` — виключає папку `cache` в директорії-джерелі.

## Крок 3: Синхронізація з видаленням

Щоб створити точну копію (дзеркало) і видалити у призначенні файли, яких немає у джерелі, додайте параметр `--delete`.

```bash
sudo rsync -avz --progress -h --delete --rsync-path="sudo rsync" /tmp/ user@hostB:/tmp
```

**Увага:** Використовуйте `--delete` з обережністю, оскільки це може призвести до незворотної втрати даних на хості призначення.

<h2>Крок 4: Безпечний запуск з `--dry-run`</h2>

Перед виконанням команди з `--delete` настійно рекомендується робити "сухий запуск" за допомогою прапора `-n` (або `--dry-run`). Це покаже, які файли будуть змінені або видалені, але не виконає жодних дій.

```bash
# Імітація синхронізації з видаленням
sudo rsync -avz -n --delete --rsync-path="sudo rsync" /tmp/ user@hostB:/tmp
```

Проаналізуйте вивід цієї команди. Якщо він відповідає вашим очікуванням, приберіть прапор `-n` і виконайте команду для реальної синхронізації.

## Крок 5: Автоматизація за допомогою SSH-ключів

Щоб запускати `rsync` в автоматичних скриптах (наприклад, у `cron`), потрібно налаштувати вхід по SSH-ключу, щоб уникнути запиту пароля.

1.  **На Хості А** згенеруйте пару ключів, якщо їх ще немає:
    ```bash
    ssh-keygen -t rsa -b 4096
    ```
2.  **Скопіюйте публічний ключ на Хост Б**:
    ```bash
    ssh-copy-id user@hostB
    ```
Після цього команди `ssh` та `rsync` не будуть запитувати пароль для цього користувача.
