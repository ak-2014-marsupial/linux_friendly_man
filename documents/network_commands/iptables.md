`iptables` — це **прямий інструмент** для взаємодії з фреймворком **Netfilter** у ядрі Linux.

Під час виконання команди (`iptables -L`, `iptables -A` тощо) вона **не читає конфігураційні файли**. Замість цього, вона напряму звертається до ядра, щоб показати або змінити правила, що зберігаються в оперативній пам'яті.

**Файли для збереження:** Оскільки правила `iptables` в ядрі зникають після перезавантаження, існують утиліти для їх збереження у файл. Команда `iptables` сама не читає їх автоматично, але може завантажити з них правила. Розташування цих файлів залежить від дистрибутива:
*   **Debian/Ubuntu:** `/etc/iptables/rules.v4` та `rules.v6` (за допомогою `iptables-persistent`).
*   **RHEL/CentOS:** `/etc/sysconfig/iptables`.

---

Команда `iptables` (IP tables) — це потужний інструмент командного рядка в Linux, який використовується для налаштування, підтримки та перевірки таблиць правил фільтрації IP-пакетів у ядрі Linux. Вона є основним інструментом для керування мережевим брандмауером.

`iptables` працює з таблицями, які містять ланцюжки правил. Кожен ланцюжок — це набір правил, що застосовуються до пакетів, які проходять через нього.

### **Основні концепції**

#### 1. Таблиці (Tables)
`iptables` має кілька таблиць для різних типів операцій. Найважливіші з них:

| Таблиця | Призначення |
| :--- | :--- |
| **`filter`** | **(За замовчуванням)** Найчастіше використовувана таблиця. Відповідає за фільтрацію пакетів (дозволити/заборонити). |
| **`nat`** | (Network Address Translation) Використовується для трансляції мережевих адрес, наприклад, для маскарадингу (NAT) або перенаправлення портів. |
| **`mangle`** | Використовується для модифікації IP-заголовків пакетів (наприклад, для зміни TTL або TOS). |
| **`raw`** | Використовується для роботи з "сирими" пакетами до того, як ядро почне їх відстежувати. |

#### 2. Ланцюжки (Chains)
Кожна таблиця містить вбудовані ланцюжки, до яких можна додавати правила. Основні ланцюжки в таблиці `filter`:

| Ланцюжок | Опис |
| :--- | :--- |
| **`INPUT`** | Правила для пакетів, що надходять на сам сервер. |
| **`OUTPUT`** | Правила для пакетів, що генеруються на самому сервері. |
| **`FORWARD`** | Правила для пакетів, що проходять через сервер (маршрутизуються). |

#### 3. Правила (Rules)
Правило — це умова, якій має відповідати пакет, і дія, яку потрібно виконати, якщо умова істинна.

| Дія (Target) | Опис |
| :--- | :--- |
| **`ACCEPT`** | Дозволити проходження пакета. |
| **`DROP`** | Мовчки відхилити пакет (пакет просто зникає). |
| **`REJECT`** | Відхилити пакет і повідомити відправника про помилку. |
| **`LOG`** | Записати інформацію про пакет у системний журнал. |

---

### **Базовий синтаксис**

```bash
iptables [-t таблиця] <команда> [ланцюжок] [умови] [-j дія]
```

*   `-t таблиця`: Вказує таблицю для роботи (за замовчуванням `filter`).
*   `<команда>`: Основна дія (наприклад, `-A` для додавання правила, `-D` для видалення, `-L` для перегляду).
*   `[ланцюжок]`: Ланцюжок, до якого застосовується правило (`INPUT`, `OUTPUT`, `FORWARD`).
*   `[умови]`: Критерії для відбору пакетів (наприклад, `-p tcp --dport 22`).
*   `-j дія`: Дія, яку потрібно виконати (`ACCEPT`, `DROP`, `REJECT`).

---

### **Основні команди та опції**

| Команда/Опція | Пояснення |
| :--- | :--- |
| **`-L`** | (`--list`) Показати правила у вказаному ланцюжку. |
| **`-A`** | (`--append`) Додати правило в кінець ланцюжка. |
| **`-I`** | (`--insert`) Вставити правило на початок або за вказаним номером. |
| **`-D`** | (`--delete`) Видалити правило за номером або за його описом. |
| **`-F`** | (`--flush`) Очистити всі правила з ланцюжка. |
| **`-P`** | (`--policy`) Встановити політику за замовчуванням для ланцюжка (наприклад, `iptables -P INPUT DROP`). |
| **`-v`** | (`--verbose`) Показати детальну інформацію (кількість пакетів, трафік). |
| **`-n`** | (`--numeric`) Відображати IP-адреси та порти в числовому форматі (швидше, без DNS-запитів). |
| **`--line-numbers`** | Показати номери правил у ланцюжку. |

---

### **Приклади використання**

1.  **Переглянути всі правила в таблиці `filter`:**
    ```bash
    sudo iptables -L -v -n
    ```
    * `-L`: список правил, `-v`: детально, `-n`: без перетворення IP в імена.

2.  **Встановити політику за замовчуванням — заборонити весь вхідний трафік:**
    Це хороший старт для налаштування безпечного брандмауера.
    ```bash
    sudo iptables -P INPUT DROP
    sudo iptables -P FORWARD DROP
    sudo iptables -P OUTPUT ACCEPT  # Дозволити вихідний трафік
    ```

3.  **Дозволити вхідні з'єднання на певні порти:**
    Наприклад, для SSH (порт 22), HTTP (80) та HTTPS (443).
    ```bash
    # Дозволити вже встановлені з'єднання
    sudo iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

    # Дозволити SSH
    sudo iptables -A INPUT -p tcp --dport 22 -j ACCEPT

    # Дозволити HTTP та HTTPS
    sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
    sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
    ```

4.  **Дозволити трафік з певного IP-адреси:**
    ```bash
    sudo iptables -A INPUT -s 192.168.1.100 -j ACCEPT
    ```
    * `-s` (`--source`) вказує IP-адресу джерела.

5.  **Заблокувати IP-адресу:**
    ```bash
    sudo iptables -A INPUT -s 8.8.8.8 -j DROP
    ```

6.  **Видалити правило:**
    Спочатку подивіться номери правил:
    ```bash
    sudo iptables -L --line-numbers
    ```
    Потім видаліть правило за його номером (наприклад, правило №5 у ланцюжку `INPUT`):
    ```bash
    sudo iptables -D INPUT 5
    ```

7.  **Збереження та відновлення правил:**
    Правила `iptables` скидаються після перезавантаження системи. Щоб зберегти їх, використовуйте утиліти:
    *   **Debian/Ubuntu:** `sudo apt-get install iptables-persistent`
        ```bash
        sudo netfilter-persistent save
        ```
    *   **CentOS/RHEL:** `sudo service iptables save`

---

### **NAT (Network Address Translation)**

Приклад налаштування простого NAT для роздачі інтернету з `eth0` (зовнішній інтерфейс) в локальну мережу `eth1`.

```bash
# 1. Увімкнути IP Forwarding
echo 1 | sudo tee /proc/sys/net/ipv4/ip_forward

# 2. Додати правило для маскарадингу в таблицю nat
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# 3. Дозволити проходження трафіку
sudo iptables -A FORWARD -i eth1 -o eth0 -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth1 -m state --state RELATED,ESTABLISHED -j ACCEPT
```