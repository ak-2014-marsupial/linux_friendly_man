Команда `strace` (system call trace) — це потужний інструмент для діагностики, моніторингу та зневадження програм у Linux. Вона перехоплює та записує всі системні виклики, які робить процес, а також сигнали, які він отримує. Це дозволяє зрозуміти, як програма взаємодіє з ядром системи: які файли відкриває, куди підключається по мережі, як працює з пам'яттю тощо.

`strace` є незамінним інструментом для аналізу "чорних скриньок" — програм, вихідний код яких вам недоступний.

#### **Базовий синтаксис**

Запустити команду під трасуванням:
```bash
strace [опції] <команда>
```

Підключитися до вже запущеного процесу:
```bash
sudo strace -p <PID>
```
*Для підключення до чужого процесу потрібні права `sudo`.*

---

### **Основні опції та їх комбінації**

| Опція/Комбінація | Пояснення |
| :--- | :--- |
| **`strace <команда>`** | Запустити `<команду>` і вивести всі її системні виклики на екран. |
| **`-p <PID>`** | Підключитися до процесу з указаним ID (PID) і почати його трасування. |
| **`-f`** | Слідкувати за всіма дочірніми процесами, які створюються основною програмою. |
| **`-o <файл>`** | Записати результати трасування у вказаний файл замість виводу на екран. |
| **`-e <вираз>`** | Фільтрувати вивід, показуючи лише певні системні виклики. Наприклад, `-e trace=open,read,write`. |
| **`-c`** | Замість повного трасування, на виході показати зведену статистику: кількість викликів, помилки та витрачений час. |
| **`-T`** | Показувати час, витрачений на виконання кожного системного виклику. |
| **`-s <розмір>`** | Вказати максимальний розмір рядків для виводу (за замовчуванням 32). `-s 1024` покаже більше даних. |

---

### **Розшифровка виводу `strace`**

Приклад виводу `strace ls /tmp/nonexistent`:
```
...
openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3
...
write(2, "ls: cannot access '/tmp/nonexist"..., 48) = 48
...
exit_group(2)                           = ?
```

*   **`openat(...)`**: Назва системного виклику.
*   **`(...)`**: Аргументи, передані у виклик.
*   **`= 3`**: Значення, яке повернув системний виклик (у цьому випадку, файловий дескриптор).
*   **`write(2, "...", 48)`**: Запис у файловий дескриптор `2` (stderr) рядка, що починається з "ls: cannot access...".
*   **`= 48`**: Кількість записаних байтів.
*   **`exit_group(2)`**: Процес завершується з кодом повернення `2`.

---

### **Приклади використання**

1.  **Протрасувати просту команду:**
    ```bash
    strace ls -l
    ```

2.  **Підключитися до запущеного процесу (наприклад, веб-сервера Nginx):**
    Спочатку знаходимо PID: `pidof nginx`. Потім підключаємося:
    ```bash
    sudo strace -p $(pidof nginx)
    ```

3.  **Відстежити лише операції з файлами:**
    Це покаже, які файли програма намагається відкрити, читати або писати.
    ```bash
    strace -e trace=file ./my_program
    ```
    *`trace=file` — це синонім для `trace=open,stat,chmod,unlink,...`*

4.  **Відстежити мережеву активність:**
    ```bash
    strace -e trace=network ./my_program
    ```

5.  **Зберегти повний лог трасування у файл:**
    Це корисно для аналізу довгих або складних процесів.
    ```bash
    sudo strace -f -o nginx_trace.log -p $(pidof nginx)
    ```

6.  **Отримати зведену статистику по системних викликах:**
    Дуже зручно для швидкої оцінки, чим займається програма.
    ```bash
    strace -c ./my_program
    ```

---

### **Продвинуті приклади**

1.  **Знайти, який конфігураційний файл програма не може знайти:**
    Якщо програма скаржиться, що не може знайти конфіг, можна відстежити невдалі спроби виклику `openat`.
    ```bash
    strace -e trace=openat ./my_app 2>&1 | grep "ENOENT"
    ```
    *`ENOENT` — це помилка "No such file or directory". `2>&1` перенаправляє stderr в stdout.*

2.  **Подивитися, що саме програма пише в лог-файл:**
    ```bash
    sudo strace -p $(pidof my_app) -e write -s 1024
    ```
