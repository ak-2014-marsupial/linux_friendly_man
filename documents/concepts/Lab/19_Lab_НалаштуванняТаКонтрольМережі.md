# Лабораторна робота: Налаштування та контроль мережі

## Частина 1: Початкове налаштування та перевірка

### 1. Параметри системи для проходження завдання
1.  Створіть дві віртуальні машини.
2.  У властивостях кожної з них (`Virtualbox → Machine → Settings`) додайте мережевий адаптер, що працює в режимі мережевого мосту (bridge).
3.  Переконайтеся, що `NetworkManager` автоматично створив з'єднання для нового мережевого інтерфейсу.
    - `ip a`: перевірте наявність нового мережевого інтерфейсу.
    - `nmcli con`: перевірте наявність з'єднання для нового інтерфейсу.
    - `nmcli con edit <назва з'єднання>`: перегляньте та за потреби змініть параметри.
4.  Якщо є, видаліть маршрут за замовчуванням з першого інтерфейсу (`enp0s3`) за допомогою `nmcli`:
    *   **Визначте назву активного з'єднання** для інтерфейсу `enp0s3`. Зазвичай це "Wired connection 1" або подібне.
        ```bash
        nmcli con show --active
        ```
        Знайдіть у виводі рядок, де `DEVICE` вказує на `enp0s3`. Запам'ятайте його `NAME`.
    *   **Змініть параметри з'єднання**, щоб воно більше не надавало маршрут за замовчуванням:
        ```bash
        sudo nmcli con modify "<НАЗВА_З'ЄДНАННЯ_ДЛЯ_ENP0S3>" ipv4.never-default yes
        ```
        (Замініть `"<НАЗВА_З'ЄДНАННЯ_ДЛЯ_ENP0S3>"` на фактичну назву, яку ви визначили на попередньому кроці).
    *   **Перезапустіть з'єднання**, щоб застосувати зміни:
        ```bash
        sudo nmcli con down "<НАЗВА_З'ЄДНАННЯ_ДЛЯ_ENP0S3>"
        sudo nmcli con up "<НАЗВА_З'ЄДНАННЯ_ДЛЯ_ENP0S3>"
        ```
    *   **Перевірте**, що маршрут за замовчуванням було видалено:
        ```bash
        ip r
        ```
        Ви більше не повинні бачити рядок, що вказує на `default via ... dev enp0s3`.

### 2. Навіщо потрібні дві віртуальні машини?
Дві віртуальні машини потрібні для перевірки мережевої взаємодії всередині налаштованих статичних підмереж. Одна віртуальна машина налаштовується з однією IP-адресою (наприклад, `10.0.0.10`), а друга — з іншою в тій самій мережі (наприклад, `10.0.0.11`). Це дозволяє переконатися, що машини бачать одна одну, і що налаштування IP-адрес, масок підмереж та мережевого мосту виконані правильно.

### 3. Перевірка мережевих налаштувань

- **Перегляд стану інтерфейсу:**
  Команда `ip a` (або `ip addr show`) відображає інформацію про всі мережеві інтерфейси в системі.

- **Перезапуск отримання IP-адреси:**
  Якщо `ip a` не показує IP-адресу, можливо, `NetworkManager` не зміг її отримати.
    - `sudo nmcli con reload <назва>`: Перезавантажує конфігурацію з'єднання з файлу.
    - `sudo nmcli con up <назва>`: Активує з'єднання, примушуючи `NetworkManager` спробувати отримати IP-адресу знову.
  
  > `<назва>` — це **ім'я мережевого з'єднання** (`CONNECTION ID`), яким керує `NetworkManager`.
  > Щоб побачити список всіх доступних з'єднань та їхні назви, виконайте:
  > ```bash
  > nmcli con show
  > ```
  > Потрібна назва буде в першій колонці (`NAME`).

- **Перевірка застосованих параметрів:**
    - `nmcli con show <назва>`: Виводить деталі збереженого з'єднання.
    - `ip a`: Показує фактичні IP-адреси та стан інтерфейсів.
    - `ip r`: Відображає таблицю маршрутизації.
    - `nmcli dev show <пристрій>`: Показує поточний активний стан пристрою.

- **Перевірка доступу до Інтернету:**
    - `ping 8.8.8.8`: Надсилає запити до Google DNS. Успішна відповідь означає, що є зв'язок з Інтернетом.

- **Трасування шляху пакетів:**
    - `traceroute 8.8.8.8`: Відстежує шлях пакетів до `8.8.8.8`, показуючи всі проміжні маршрутизатори.

- **Перегляд конфігурації DNS:**
    - `cat /etc/resolv.conf`: Показує DNS-сервери, які використовує система.

---

## Частина 2: Статичні налаштування мережі

> **Примітка:** Кроки з цієї частини потрібно виконати на **обох** віртуальних машинах, щоб налаштувати між ними статичну мережу.
> *   **На першій машині** в файлі конфігурації встановіть `IPADDR="10.0.0.100"`.
> *   **На другій машині** в файлі конфігурації встановіть `IPADDR="10.0.0.101"`.
> 
> Це дозволить їм мати унікальні адреси в одній мережі для подальшої взаємодії.

> **Важливе зауваження для віддаленого керування:**
> При виконанні налаштувань для `enp0s8` (особливо якщо ви працюєте з машиною віддалено, наприклад, через SSH) **завжди підключайтесь до віртуальної машини через інший, стабільний інтерфейс**, який не є об'єктом поточних змін.
> 
> У вашому випадку це означає, що для керування налаштуваннями `enp0s8` (включаючи його видалення або модифікацію) слід використовувати SSH-підключення, встановлене через інтерфейс `enp0s3` (який настроєно через NAT або в режимі мосту до вашої домашньої мережі). Це гарантує, що ваш сеанс зв'язку не обірветься, якщо ви зміните або деактивуєте `enp0s8`.

### 1. Видалення існуючого з'єднання
```bash
nmcli con del <назва з'єднання>
```
Ця команда видаляє збережену конфігурацію `NetworkManager` для інтерфейсу.

### 2. Створення файлу налаштувань ifcfg
Створіть файл `/etc/sysconfig/network-scripts/ifcfg-enp0s8` з таким змістом (замініть `X` на ваш ідентифікатор хоста, наприклад, 10):
```bash
# sudo nano /etc/sysconfig/network-scripts/ifcfg-enp0s8

TYPE=Ethernet
DEVICE="enp0s8"
NAME="enp0s8"
BOOTPROTO="none"
IPADDR="10.0.0.X"
NETMASK="255.255.255.0"
GATEWAY="10.0.0.1"
DNS1="8.8.8.8"
DEFROUTE="yes"
```
- `BOOTPROTO="none"`: Вказує, що IP-адреса налаштовується вручну.

### 3. Завантаження та активація налаштувань
```bash
sudo nmcli con load /etc/sysconfig/network-scripts/ifcfg-enp0s8
sudo nmcli con up enp0s8
```
Ці команди імпортують конфігурацію з файлу та активують з'єднання.

> #### Чому з'єднання працює, навіть якщо видалити ifcfg-файл?
>
> Це важливий момент: налаштування продовжують працювати, оскільки вони вже **завантажені в пам'ять** і збережені самим `NetworkManager` в його внутрішніх профілях (зазвичай у `/etc/NetworkManager/system-connections/`).
>
> *   **Файл `ifcfg-enp0s8` — це лише початкове "креслення"**.
> *   Командою `nmcli con load` `NetworkManager` копіює ці налаштування у свій власний формат.
> *   Командою `nmcli con up` ці скопійовані налаштування застосовуються до мережевого інтерфейсу і стають активними.
>
> Видалення вихідного `ifcfg` файлу не впливає на вже скопійований профіль або активне з'єднання. Щоб налаштування **повністю зникли** (навіть після перезавантаження), потрібно видалити профіль з самого `NetworkManager` командою `nmcli con del enp0s8`.


### 4. Перевірка
- `ip a`: Перевірте, що `enp0s8` має IP-адресу `10.0.0.X`.
- `ip r`: Перевірте, що маршрут за замовчуванням вказує на `10.0.0.1`.
- `ping 10.0.0.Y`: Перевірте зв'язок з іншою віртуальною машиною.
- `ping 8.8.8.8`: Перевірте зв'язок з Інтернетом.

> **Чому `ping 8.8.8.8` не працює?**
>
> Очікувано, що ця команда **не спрацює**. Причина в тому, що вказаний шлюз (`GATEWAY="10.0.0.1"`) є лише адресою у вашій ізольованій мережі між двома віртуальними машинами. За цією адресою немає справжнього роутера, який міг би перенаправити ваш трафік в інтернет.
>
> Мета цього кроку — навчитися налаштовувати маршрут за замовчуванням, а не отримати реальний доступ до інтернету через цей інтерфейс.

---

## Частина 3: Динамічні налаштування мережі ("на льоту")

> **У чому ціль таких налаштувань?**
>
> Основна мета налаштувань "на льоту" (за допомогою команд `ip`, `route` тощо) — це **швидка, тимчасова зміна або діагностика мережі**, яка не зберігається після перезавантаження. Це потужний інструмент для:
> *   **Діагностики:** Швидка перевірка гіпотез (напр., додати маршрут, щоб побачити, чи з'явиться зв'язок).
> *   **Аварійного відновлення:** Ручне відновлення зв'язку через консоль, коли основна конфігурація пошкоджена.
> *   **Тимчасових завдань:** Короткочасна зміна IP або маршруту для виконання специфічної операції.
>
> У робочому середовищі (production) такі команди використовуються для діагностики, але **ніколи** для внесення постійних змін. Будь-яка зміна, що має залишитися, вноситься через `nmcli` або конфігураційні файли.

Ці команди змінюють налаштування безпосередньо в ядрі, і зміни будуть втрачені після перезавантаження.

### 1. Зміна IP-адреси та маршруту
```bash
# Видалити поточну IP-адресу
sudo ip a del 10.0.0.X/24 dev enp0s8

# Додати нову IP-адресу
sudo ip a add 172.16.0.X/24 dev enp0s8

# Видалити поточний маршрут за замовчуванням
sudo ip r del default

# Додати новий маршрут за замовчуванням
sudo ip r add default via 172.16.0.1
```

### 2. Перевірка
- `ip a`: Переконайтесь, що `enp0s8` має нову IP-адресу `172.16.0.X`.
- `ip r`: Переконайтесь, що маршрут за замовчуванням вказує на `172.16.0.1`.
- `ping 8.8.8.8`: Перевірте зв'язок з Інтернетом.

### 3. Повернення до збережених налаштувань
```bash
sudo nmcli con up enp0s8
```
Ця команда повторно застосує параметри, збережені в `NetworkManager` (зі Частини 2), скасовуючи зміни, зроблені "на льоту".

---

## Частина 4: Постійне збереження змін

> **Чим цей спосіб відрізняється від налаштувань "на льоту"?**
>
> На відміну від команд `ip`, які змінюють лише тимчасовий "живий" стан мережі в ядрі, команди `nmcli con mod` (modify) працюють з **постійними профілями з'єднань**, що зберігаються `NetworkManager`.
>
> *   **`ip`**: Тимчасові зміни, що зникають після перезавантаження.
> *   **`nmcli con mod`**: Постійні зміни, які зберігаються і автоматично застосовуються при старті системи.
>
> Ця частина демонструє, як правильно зберігати зміни, щоб вони залишалися чинними.

### 1. Редагування з'єднання (спосіб 1: інтерактивний)
```bash
sudo nmcli con edit enp0s8
```
В інтерактивному режимі виконайте:
```
set ipv4.addresses 172.16.0.X/24
set ipv4.gateway 172.16.0.1
set ipv4.dns 8.8.8.8
save
quit
```

### 2. Редагування з'єднання (спосіб 2: прямі команди)
```bash
sudo nmcli con mod enp0s8 ipv4.addresses "172.16.0.X/24"
sudo nmcli con mod enp0s8 ipv4.gateway "172.16.0.1"
sudo nmcli con mod enp0s8 ipv4.method manual
sudo nmcli con mod enp0s8 ipv4.dns "8.8.8.8"
```

### 3. Застосування та перевірка
```bash
sudo nmcli con up enp0s8
```
Перевірте налаштування за допомогою `ip a` та `ip r`. Тепер вони збережені на постійній основі.

---

## Частина 5: Робота з кількома IP-адресами

### 1. Додавання другої IP-адреси "на льоту"
```bash
sudo ip a add <IP_адреса_з_мережі_хоста>/<CIDR> dev enp0s8
```
Наприклад: `sudo ip a add 192.168.1.150/24 dev enp0s8`. Тепер інтерфейс матиме дві IP-адреси.

### 2. Зміна маршруту за замовчуванням
```bash
# Видалити поточний маршрут
sudo ip r del default

# Додати новий маршрут через роутер домашньої мережі
sudo ip r add default via <IP_роутера_домашньої_мережі>
```

### 3. Перевірка
- `ip a`: Переконайтесь, що інтерфейс має обидві IP-адреси.
- `ip r`: Перевірте новий маршрут.
- `ping <IP_роутера_домашньої_мережі>`: Перевірте зв'язок з роутером.
- `ping 8.8.8.8`: Перевірте зв'язок з Інтернетом через новий шлюз.

### 4. Скидання тимчасових змін
```bash
sudo nmcli con up enp0s8
```
Ця команда знову застосує збережені налаштування з Частини 4, і всі зміни "на льоту" (додаткова IP-адреса, новий маршрут) будуть скинуті.

---

## Частина 6: Повернення до вихідних налаштувань

Щоб повернути налаштування до отримання IP-адреси по DHCP, як на початку:
```bash
# Створюємо нове з'єднання з автоматичним отриманням IP (DHCP)
sudo nmcli con add type ethernet ifname enp0s8 con-name "enp0s8-dhcp-auto"
sudo nmcli con modify enp0s8-dhcp-auto ipv4.method auto

# Активуємо його
sudo nmcli con up enp0s8-dhcp-auto
```
Після цього переконайтесь, що інтерфейс `enp0s8` отримав IP-адресу з вашої домашньої мережі за допомогою `ip a`.
