# Лабораторна робота: Аналіз підсистеми DNS

> **Мета роботи:** Навчитися діагностувати стан мережевих налаштувань та роботу підсистеми DNS, використовувати утиліти `ping`, `nslookup`, `host`, та `dig` для перевірки та запитів до DNS-серверів, а також зрозуміти механізми розв'язання імен в Linux, включаючи файли `/etc/resolv.conf`, `/etc/hosts` та `/etc/nsswitch.conf`.

---

### Підготовка: Встановлення необхідних утиліт

Перед початком лабораторної роботи переконайтеся, що на вашій віртуальній машині (Red Hat-based system) встановлені всі необхідні мережеві та діагностичні утиліти. Деякі з них можуть бути відсутні за замовчуванням.

Для перевірки наявності пакета використовуйте команду `rpm -q <назва_пакета>`. Якщо пакет не встановлено, ви отримаєте повідомлення про його відсутність.

Для встановлення пакетів використовуйте менеджер пакетів `dnf`:

```bash
# Перевірка та встановлення утиліт для DNS (dig, host, nslookup), що входять до пакету bind-utils
# bind-utils часто не встановлений за замовчуванням
sudo dnf install bind-utils -y

# Перевірка та встановлення інструментів для роботи з IP-адресами та маршрутизацією (ip, ss)
# iproute2 зазвичай встановлений
sudo dnf install iproute2 -y

# Перевірка та встановлення утиліт для ping
# iputils зазвичай встановлений
sudo dnf install iputils -y

# Перевірка та встановлення текстового редактора (наприклад, nano)
# Якщо ви віддаєте перевагу vim, встановіть його замість nano
sudo dnf install nano -y

# Для використання nmcli, переконайтеся, що встановлений NetworkManager
# NetworkManager зазвичай встановлений
sudo dnf install NetworkManager -y
```

**Примітка:** Після встановлення деяких пакетів, можливо, доведеться перезавантажити термінал або сесію для коректного оновлення змін в PATH або середовищі.

---

### 1. Перегляд початкового стану мережі та DNS

**Завдання:** Перевірити поточні мережеві налаштування, з'єднання з Інтернетом та працездатність системи доменних імен (DNS).

**Команди:**
```bash
# 1. Перегляд IP-адрес та інтерфейсів
ip a

# 2. Перегляд таблиці маршрутизації
ip r

# 3. Перегляд конфігурації DNS-клієнта
cat /etc/resolv.conf

# 4. Перевірка доступності Інтернету за IP та іменем
ping -c 4 8.8.8.8
ping -c 4 goo.gl

# 5. Перевірка роботи DNS-резолверів
nslookup goo.gl
host goo.gl
```

**Пояснення та очікуваний результат:**

*   `ip a` (або `ip address`): Покаже всі мережеві інтерфейси та призначені їм IP-адреси. Ви маєте побачити інтерфейс (напр., `enp0s3` або `eth0`) з вашою локальною IP-адресою.
*   `ip r` (або `ip route`): Покаже таблицю маршрутизації. Ключовим є наявність маршруту за замовчуванням (`default via ...`), який вказує, куди відправляти трафік до зовнішніх мереж.
*   `cat /etc/resolv.conf`: Відобразить IP-адреси DNS-серверів, які використовує ваша система. Зазвичай тут вказаний локальний кешуючий сервер або DNS-сервер вашого роутера/провайдера.
    ```
    # Приклад виводу /etc/resolv.conf
    nameserver 192.168.1.1
    nameserver 8.8.8.8
    ```
*   `ping -c 4 8.8.8.8`: Ця команда перевіряє, чи є у вас зв'язок з Інтернетом на мережевому рівні, надсилаючи 4 пакети на публічний DNS-сервер Google. Якщо пінги проходять (`4 packets transmitted, 4 received`), значить, маршрутизація працює.
*   `ping -c 4 goo.gl`: Ця команда перевіряє повний цикл: і роботу DNS (перетворення `goo.gl` на IP-адресу), і зв'язок з Інтернетом. Якщо вона успішна, ваша мережа налаштована правильно.
*   `nslookup goo.gl` та `host goo.gl`: Ці утиліти напряму запитують у DNS-сервера (вказаного в `/etc/resolv.conf`) IP-адресу для домену `goo.gl`. Успішна відповідь підтверджує, що підсистема DNS працює коректно.

**Висновки:** Якщо всі команди виконались успішно, це означає, що мережеві налаштування коректні, є доступ до Інтернету, і система може успішно перетворювати доменні імена в IP-адреси.

---

### 2. Симуляція збою DNS

**Завдання:** "Зламати" налаштування DNS, видаливши інформацію про DNS-сервери, та перевірити наслідки.

**Команди:**
```bash
# 1. Створити резервну копію файлу налаштувань
cp /etc/resolv.conf ~/resolv.conf.bak

# 2. Очистити або видалити вміст файлу (потрібні права root)
sudo sh -c '> /etc/resolv.conf'

# Альтернативні способи очищення файлу:
# За допомогою команди tee:
echo '' | sudo tee /etc/resolv.conf
# Або відкривши файл в текстовому редакторі (sudo nano /etc/resolv.conf) і видаливши всі рядки.

# 3. Перевірити працездатність підключення
ping -c 4 8.8.8.8
ping -c 4 goo.gl
```

**Пояснення:**

*   `cp /etc/resolv.conf ~/resolv.conf.bak`: Ми копіюємо оригінальний файл конфігурації у ваш домашній каталог, щоб потім можна було легко його відновити.
*   `sudo sh -c '> /etc/resolv.conf'`: Ця команда перезаписує файл `/etc/resolv.conf` порожнім вмістом. Права суперкористувача (`sudo`) потрібні, оскільки це системний файл. Тепер ваша система не знає, до якого DNS-сервера звертатися.

**Очікуваний результат:**

*   `ping -c 4 8.8.8.8`: **Ця команда буде успішною.** Пряме з'єднання за IP-адресою не вимагає DNS, тому система, як і раніше, може достукатися до сервера Google. Це показує, що мережевий зв'язок як такий не зник.
*   `ping -c 4 goo.gl`: **Ця команда зазнає невдачі.** Ви побачите помилку на кшталт `ping: goo.gl: Name or service not known` або `Temporary failure in name resolution`. Система намагається знайти IP-адресу для `goo.gl`, але не має інформації про DNS-сервери, до яких можна було б звернутися із запитом.

**Висновки:** Файл `/etc/resolv.conf` є критично важливим для роботи DNS-клієнта. Без нього система втрачає здатність перетворювати доменні імена в IP-адреси, що робить більшу частину Інтернету недоступною за звичними іменами, хоча доступ за прямими IP-адресами залишається.

---

### 3. Поглиблений аналіз DNS за допомогою `dig`

**Завдання:** Використовувати утиліту `dig` для надсилання специфічних запитів до різних DNS-серверів та аналізувати їх відповіді.

**Пояснення `dig`:**
`dig` (Domain Information Groper) — потужна утиліта для діагностики DNS. На відміну від `ping` або `host`, вона показує повну відповідь від сервера, включаючи різні секції, що дуже корисно для аналізу.

#### 3.1. Запит A-запису (IP-адреса)

**Команди:**
```bash
# Запит до публічного DNS Google
dig @8.8.8.8 A goo.gl

# Запит до кастомного DNS-сервера лабораторії
dig @54.37.30.233 -p 5353 A goo.gl
```

**Аналіз відповіді:**
*   **Синтаксис:** `dig @<DNS-сервер> <тип запису> <доменне ім'я>`. Прапор `-p` дозволяє вказати нестандартний порт.
*   **`ANSWER SECTION`:** Це найважливіша частина. Вона містить пряму відповідь на ваш запит. Для `A` запиту тут буде IP-адреса (наприклад, `goo.gl. 300 IN A 142.250.180.206`).
*   **`AUTHORITY SECTION`:** Ця секція з'являється, якщо DNS-сервер, до якого ви звернулися, не є авторитетним (головним) для цієї зони. Він вказує на ті сервери, які є авторитетними (NS-сервери).

#### 3.2. Запит NS-запису (Сервери імен)

**Команди:**
```bash
# Запит NS-серверів для зони google.com
dig @8.8.8.8 NS google.com

# Запит NS-серверів для зони goo.gl
dig @54.37.30.233 -p 5353 NS goo.gl
```
**Аналіз відповіді:**
У `ANSWER SECTION` ви побачите список `NS` записів — це імена серверів (напр., `ns1.google.com`), які відповідають за доменну зону `google.com` або `goo.gl`.

#### 3.3. Запит для непублічних (локальних) зон

**Команди:**
```bash
# Запит для server.local до публічного DNS
dig @8.8.8.8 A server.local

# Запит для server.local до кастомного DNS
dig @54.37.30.233 -p 5353 A server.local
```
**Аналіз відповіді:**
*   Запит до `8.8.8.8` (публічного сервера) для `server.local` (приватного імені) скоріш за все поверне статус `NXDOMAIN` (Non-Existent Domain) і порожню `ANSWER SECTION`. Публічні сервери нічого не знають про приватні мережі.
*   Запит до `54.37.30.233 -p 5353` може повернути IP-адресу, якщо цей сервер налаштований для обслуговування зони `.local`.

**Команди:**
```bash
# Запит NS-серверів для зони .local
dig @8.8.8.8 NS local
dig @54.37.30.233 -p 5353 NS local
```
**Аналіз відповіді:**
Аналогічно, публічний DNS-сервер не знає, хто відповідає за зону `.local`, тоді як приватний сервер може надати цю інформацію.

#### 3.4. Пошук кореневих DNS-серверів

**Завдання:** Знайти список DNS-серверів, відповідальних за кореневу зону `.`

**Команда:**
```bash
# Запит NS-записів для кореневої зони "."
dig NS .
```
**Результат:** У відповіді ви побачите список з 13 кореневих серверів, імена яких знаходяться в діапазоні від `a.root-servers.net` до `m.root-servers.net`. Це основа всього Інтернету.

**Завдання:** Знайти IP-адресу одного з них.

**Команда:**
```bash
# Наприклад, для a.root-servers.net
dig A a.root-servers.net
```

**Висновки по розділу:**
*   Утиліта `dig` дозволяє робити точні запити до конкретних DNS-серверів, що ігнорує локальні налаштування системи (`/etc/resolv.conf`, `/etc/hosts`).
*   Існують різні типи DNS-записів (`A`, `NS`, `MX` тощо) для різних цілей.
*   DNS-сервери бувають публічними (як `8.8.8.8`), які знають про публічні домени, та приватними, які можуть обслуговувати локальні доменні зони (як `.local`).

---

### 4. Відновлення налаштувань DNS

**Завдання:** Повернути оригінальний файл `/etc/resolv.conf` і перевірити, чи все запрацювало знову.

**Команди:**
```bash
# 1. Відновити файл конфігурації з резервної копії (потрібні права root)
sudo cp ~/resolv.conf.bak /etc/resolv.conf

# 2. Перевірити працездатність
ping -c 4 goo.gl
nslookup goo.gl
host goo.gl
```

**Очікуваний результат:**
Після відновлення файлу `resolv.conf` всі команди знову повинні виконуватися успішно. `ping goo.gl` знайде хост, а `nslookup` та `host` покажуть його IP-адресу.

**Висновки:** Відновлення коректного файлу `/etc/resolv.conf` миттєво повертає системі здатність до розв'язання доменних імен.

---

### 5. Пріоритет розв'язання імен: `/etc/hosts`

**Завдання:** Дослідити, як файл `/etc/hosts` може перевизначити відповіді від DNS-серверів.

**Команди:**
```bash
# 1. Переглянути поточний порядок розв'язання імен
cat /etc/nsswitch.conf

# 2. Додати запис у /etc/hosts (потрібні права root)
# Відкрийте файл: sudo nano /etc/hosts
# І додайте в кінець файлу такий рядок:
127.0.0.1   goo.gl

# 3. Перевірити результат
ping -c 4 goo.gl
dig goo.gl
host goo.gl
```
**Пояснення:**
*   `cat /etc/nsswitch.conf`: Цей файл керує тим, де і в якому порядку система шукає різну інформацію. Нас цікавить рядок `hosts:`. Зазвичай він виглядає так: `hosts: files dns`. Це означає: "спочатку подивись у локальні файли (`/etc/hosts`), а якщо там нічого не знайдеш, запитай у DNS".
*   `127.0.0.1   goo.gl`: Ми додали запис, який "каже" системі, що домен `goo.gl` відповідає IP-адресі `127.0.0.1` (localhost).

**Очікуваний результат:**
*   `ping -c 4 goo.gl`: Пінг буде йти на `127.0.0.1`! Команда `ping` підкоряється налаштуванням `nsswitch.conf`, бачить запис у `/etc/hosts` першим і використовує його, навіть не звертаючись до DNS.
*   `dig goo.gl` та `host goo.gl`: **Ці утиліти покажуть справжню, публічну IP-адресу `goo.gl`!** Це ключовий момент: `dig` і `host` — це інструменти для прямої діагностики DNS. Вони ігнорують файл `/etc/hosts` і завжди звертаються до DNS-сервера.

**Висновки:** Файл `/etc/hosts` має вищий пріоритет над DNS (за замовчуванням). Це дозволяє локально "підміняти" IP-адреси для будь-яких доменів, що корисно для розробки, тестування або блокування сайтів. Системні утиліти (`ping`, браузери) будуть використовувати `/etc/hosts`, а діагностичні (`dig`, `host`) — ні.

---

### 6. Зміна послідовності розв'язання імен

**Завдання:** Змінити пріоритет, щоб DNS запити виконувались раніше, ніж перевірка `/etc/hosts`.

**Команди:**
```bash
# 1. Змінити порядок у /etc/nsswitch.conf (потрібні права root)
# Відкрийте файл: sudo nano /etc/nsswitch.conf
# Змініть рядок 'hosts: files dns' на:
hosts: dns files

# 2. Перевірити результат
ping -c 4 goo.gl
```
**Після тесту не забудьте повернути налаштування назад на `hosts: files dns`!**

**Очікуваний результат:**
*   `ping -c 4 goo.gl`: Тепер `ping` буде йти на **справжню, публічну IP-адресу** `goo.gl`. Оскільки в `nsswitch.conf` ми вказали `dns` першим, система спочатку запитує DNS-сервер, отримує відповідь і використовує її. До перевірки `/etc/hosts` черга просто не доходить.

**Висновки:** Порядок, вказаний у файлі `/etc/nsswitch.conf` в рядку `hosts:`, прямо контролює механізм розв'язання імен в операційній системі.

---

### 7. Практичне застосування `/etc/hosts`

**Завдання:** Додати в файл `/etc/hosts` запис, щоб по ніку сусіда пінгувався відповідний ІР.

**Пояснення та дії:**
Це просте практичне завдання на використання `/etc/hosts` для зручності роботи в локальній мережі.

1.  Дізнайтеся IP-адресу віртуальної машини вашого сусіда (напр., `192.168.56.102`).
2.  Вигадайте для нього псевдонім (напр., `sosed`).
3.  Відкрийте файл `/etc/hosts` з правами суперкористувача:
    ```bash
    sudo nano /etc/hosts
    ```
4.  Додайте в кінець файлу рядок у форматі `IP-адреса псевдонім`:
    ```
    192.168.56.102   sosed
    ```
5.  Збережіть файл. Тепер ви можете "пінгувати" сусіда за іменем:
    ```bash
    ping sosed
    ```
    Система знайде цей запис у `/etc/hosts` і відправить пакети на `192.168.56.102`.