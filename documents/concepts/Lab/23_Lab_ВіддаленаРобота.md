# Лабораторна робота: Віддалена робота

> **Мета роботи:** Навчитися налаштовувати та використовувати службу SSH для безпечного віддаленого доступу до сервера, змінювати стандартні налаштування, налаштовувати автентифікацію за допомогою ключів та використовувати конфігураційні файли для спрощення підключень.

---

## Підготовка до виконання роботи

**Завдання:** Виконати початкові налаштування віртуальної машини для забезпечення доступу до неї з локальної мережі.

**Пояснення кроків:**

1.  **Повністю вимкнути ВМ:** Це необхідно, оскільки зміна конфігурації мережевих адаптерів у VirtualBox вимагає, щоб машина була у стані `Poweroff`, а не `Saved`.

2.  **Додати мережевий адаптер (Bridged Adapter):**
    *   **Що це робить?** Створює віртуальний мережевий міст між вашою ВМ та фізичною мережею. Ваша ВМ стає повноцінним учасником локальної мережі, так само як ваш комп'ютер чи телефон.
    *   **Навіщо це потрібно?** Щоб ваш домашній роутер видав ВМ власну IP-адресу, за якою до неї можна буде звернутися з інших пристроїв у тій самій мережі.

3.  **Перевірка налаштувань в ВМ:**
    *   **`ip a`:** Ця команда покаже список усіх мережевих інтерфейсів. Ви повинні побачити новий інтерфейс (наприклад, `enp0s8`), якому DHCP-сервер вашого роутера присвоїв IP-адресу з вашої локальної мережі (наприклад, `192.168.1.15`).
    *   **`nmcli con`:** NetworkManager, стандартний інструмент керування мережею в багатьох дистрибутивах, автоматично створює профіль (з'єднання) для нового інтерфейсу. Ця команда покаже вам назву цього з'єднання, яке можна використовувати для подальших налаштувань.

4.  **Вимкнення фаєрвола:**
    *   **`systemctl stop iptables`:** Ця команда (або `systemctl stop firewalld` / `ufw disable` в залежності від дистрибутива) тимчасово вимикає фаєрвол.
    *   **Навіщо це потрібно?** Для навчальних цілей це спрощує завдання, усуваючи можливу причину блокування з'єднань. У реальному середовищі замість вимкнення слід було б додати правило, що дозволяє вхідний трафік на потрібний порт (наприклад, 22 для SSH).

---

### 1. Перше підключення до ВМ

**Завдання:** Підключитись до ВМ, використовуючи доданий інтерфейс (на виданий йому IP і порт SSH за замовчуванням - 22).

**Концептуальна команда (виконується на вашому основному комп'ютері):**
```bash
ssh <USER_VM>@<IP_АДРЕСА_ВМ>
```
> Замініть `<USER_VM>` на ім'я користувача на ВМ, а `<IP_АДРЕСА_ВМ>` — на IP-адресу, отриману на попередньому кроці.

**Пояснення:**
*   **`ssh`** — це клієнтська програма для підключення до віддаленого сервера по протоколу Secure Shell.
*   Ми вказуємо, під яким **користувачем** (`<USER_VM>`) і на яку **адресу** (`<IP_АДРЕСА_ВМ>`) ми хочемо підключитися.
*   Оскільки ми не вказуємо порт, `ssh` за замовчуванням буде намагатися підключитися до порту **22**, на якому зазвичай працює SSH-сервер (`sshd`).
*   При першому підключенні клієнт запитає, чи довіряєте ви "відбитку" ключа сервера. Потрібно буде ввести `yes`. Після цього вас попросять ввести пароль для `<USER_VM>`.

---

### 2. Підключення через localhost та проброс порту

**Завдання:** Підключитись до ВМ, використовуючи `localhost` + порт `12345`. Зробити висновки.

**Пояснення:**
Це завдання складається з двох частин: налаштування у VirtualBox та саме підключення.

1.  **Налаштування пробросу порту (Port Forwarding):**
    *   Зайдіть у налаштування ВМ (вона має бути вимкнена) → `Network` → адаптер `NAT` (зазвичай перший) → `Advanced` → `Port Forwarding`.
    *   Створіть нове правило:
        *   **Name:** `ssh` (або будь-яке ім'я)
        *   **Protocol:** `TCP`
        *   **Host IP:** `127.0.0.1` (це `localhost` вашого комп'ютера)
        *   **Host Port:** `12345` (порт на вашому комп'ютері, який ви будете слухати)
        *   **Guest IP:** (залиште порожнім)
        *   **Guest Port:** `22` (порт SSH на вашій ВМ, куди будуть перенаправлятися з'єднання)

2.  **Підключення:** 
    ```bash
    ssh <USER_VM>@localhost -p 12345
    ```

**Висновки та різниця:**

*   **Підключення з завдання 1:** Це було **пряме** з'єднання по мережі. Ваш комп'ютер (клієнт) напряму звертався до IP-адреси ВМ (сервера) в локальній мережі. Це можливо завдяки **Bridged Adapter**.
*   **Підключення з завдання 2:** Це з'єднання через **проброс порту**. Ви підключаєтесь не до ВМ, а до порту `12345` на **вашій власній машині** (`localhost`). VirtualBox "перехоплює" це з'єднання і перенаправляє його на порт `22` всередині вашої ВМ через віртуальну мережу **NAT**. Цей метод дозволяє отримати доступ до сервісів ВМ, навіть якщо вона знаходиться за NAT і не має власної IP-адреси в локальній мережі.

---

### 3. Налаштування пробросу портів у VirtualBox

**Завдання:** Знайти в налаштуваннях VirtualBox проброс порту. Зробити висновки.

**Де знайти:**
`Налаштування ВМ` → `Network` → Оберіть адаптер, що працює в режимі `NAT` → `Advanced` → кнопка `Port Forwarding`.

**Висновки:**
*   Проброс портів є функцією, яка прив'язана до мережевого адаптера типу **NAT**. Вона не працює для режиму **Bridged**.
*   Цей механізм дозволяє "прокинути" доступ до певних портів (сервісів) віртуальної машини ззовні, роблячи їх доступними через мережевий інтерфейс хостової машини (вашого комп'ютера).
*   Це потужний інструмент для розробки та тестування, коли потрібно надати доступ до веб-сервера, бази даних чи іншого сервісу, що працює на ВМ, не виводячи саму ВМ у локальну мережу.

---

### 4. Зміна стандартного порту SSH

**Завдання:** Змінити порт 22 на 2222 в налаштуваннях `sshd`. Зробити висновок.

**Послідовність дій (на ВМ):**

1.  **Редагування конфігураційного файлу:** 
    ```bash
    # Відкрити файл з правами суперкористувача
    sudo nano /etc/ssh/sshd_config
    ```
2.  **Знайти та змінити рядок:**
    *   Знайдіть рядок `#Port 22`.
    *   Розкоментуйте його (приберіть `#`) і змініть `22` на `2222`.
    *   Має вийти: `Port 2222`.
    *   Збережіть файл (`Ctrl+O`) і закрийте редактор (`Ctrl+X`).

3.  **Перевірка до перезапуску:**
    ```bash
    ss -tulnp | grep ssh
    ```
    Вивід покаже, що `sshd` **досі** слухає порт `22`. Це тому, що сервіс ще не перечитав новий конфігураційний файл.

4.  **Перезапуск сервера SSH:**
    ```bash
    sudo systemctl restart sshd
    ```
5.  **Перевірка після перезапуску:**
    ```bash
    ss -tulnp | grep ssh
    ```
    Тепер вивід покаже, що `sshd` слухає новий порт `2222`.

**Висновок:**
Зміна конфігураційного файлу сервісу не застосовується миттєво. Щоб зміни вступили в силу, сервіс необхідно **перезапустити** (або, в деяких випадках, змусити перечитати конфігурацію командою `reload`).

---

### 5. Підключення на новий порт

**Завдання:** Підключитися до ВМ з новими налаштуваннями. Що треба змінити?

**Що треба змінити:**
При підключенні тепер потрібно явно вказувати новий порт за допомогою прапора `-p`.

**Команди для підключення:**

1.  **Пряме підключення (на Bridged IP):**
    ```bash
    ssh <USER_VM>@<IP_АДРЕСА_ВМ> -p 2222
    ```
2.  **Через проброс порту (localhost):**
    *   Спочатку потрібно змінити правило пробросу портів у VirtualBox: `Guest Port` з `22` на `2222`.
    *   Команда підключення залишиться тією ж, бо ми підключаємось до порту на хості (`12345`), а не до гостьового порту.
    ```bash
    ssh <USER_VM>@localhost -p 12345
    ```

**Висновок:**
Якщо сервіс працює на нестандартному порту, клієнтській програмі потрібно явно вказати цей порт при підключенні.

---

### 6. Повернення налаштувань

**Завдання:** Повернути налаштування на початкові.

**Пояснення:**
Потрібно виконати зворотні дії з пункту 4:
1.  Відредагувати `/etc/ssh/sshd_config`, повернувши `Port 22` (або закоментувавши рядок).
2.  Перезапустити сервіс: `sudo systemctl restart sshd`.

---

### 7. Налаштування автентифікації за ключами

**Завдання:** Забезпечити підключення до ВМ за допомогою пари RSA-ключів.

**Пояснення концепції:**
Це більш безпечний та зручний спосіб автентифікації, ніж паролі. Він складається з двох частин:
*   **Приватний ключ (`id_rsa`):** Зберігається на вашій клієнтській машині. **Ніколи нікому його не передавайте.** Це ваш секрет.
*   **Публічний ключ (`id_rsa.pub`):** Копіюється на сервер. Він не є секретним і дозволяє серверу перевірити, що ви володієте відповідним приватним ключем.

**Послідовність дій (клієнт → сервер):**

1.  **На клієнтській машині (з якої підключаєтесь):**
    ```bash
    # Згенерувати пару ключів
    ssh-keygen
    ```
    *   Програма запитає, де зберегти ключі (зазвичай `~/.ssh/id_rsa`, просто натисніть Enter).
    *   Запитає парольну фразу (passphrase). Це додатковий пароль для захисту вашого приватного ключа. Можна залишити порожнім для зручності, але це менш безпечно.

2.  **На клієнтській машині (копіювання ключа на сервер):**
    ```bash
    # Автоматично скопіювати публічний ключ на ВМ
    ssh-copy-id <USER_VM>@<IP_АДРЕСА_ВМ>
    ```
    *   Ця команда підключиться до ВМ (попросить пароль востаннє), знайде файл `~/.ssh/authorized_keys` на ВМ і допише в нього ваш публічний ключ (`id_rsa.pub`).

Після цього спробуйте підключитися знову: `ssh <USER_VM>@<IP_АДРЕСА_ВМ>`. Сервер більше не повинен питати пароль, а одразу пустить вас в систему.

---

### 8. Створення конфігураційного файлу

**Завдання:** Створити `~/.ssh/config` для спрощеного підключення.

**Пояснення:**
Цей файл дозволяє створити псевдоніми для ваших SSH-з'єднань, щоб не вводити щоразу IP-адресу, порт та ім'я користувача.

**Дії (на клієнтській машині):**

1.  **Створити/відредагувати файл:**
    ```bash
    nano ~/.ssh/config
    ```
2.  **Додати наступний вміст:**
    ```
    Host vm
        HostName <IP_АДРЕСА_ВМ>
        User <USER_VM>
        Port 2222 
    ```
    *   `Host vm`: `vm` — це псевдонім, який ви будете використовувати.
    *   `HostName`: IP-адреса або доменне ім'я сервера.
    *   `User`: Ім'я користувача для підключення.
    *   `Port`: Необов'язково, якщо використовується стандартний порт 22.

3.  **Встановити права доступу:**
    ```bash
    chmod 600 ~/.ssh/config
    ```
    *   **Пояснення `chmod 600`:** Ця команда встановлює права доступу для файлу `~/.ssh/config` таким чином, що:
        *   `6` (read+write) для власника файлу.
        *   `0` (no permissions) для групи.
        *   `0` (no permissions) для інших користувачів.
        *   Це **критично важливо** для безпеки. SSH-клієнт **відмовиться** використовувати конфігураційний файл, якщо його права доступу надто "відкриті" (наприклад, доступні для читання іншим користувачам), щоб запобігти витоку конфіденційної інформації про ваші з'єднання.

---

### 9. Видалення ключів хоста

**Завдання:** Видалити всі ключі з `/etc/ssh` на ВМ. Перевірити підключення до та після перезавантаження `sshd`.

**Пояснення:**
Файли в `/etc/ssh/` з іменами `ssh_host_*_key` — це **ключі хоста**. Вони є унікальними для кожного сервера. Коли ви підключаєтесь вперше, ваш клієнт зберігає публічну частину цього ключа в файлі `~/.ssh/known_hosts`. При наступних підключеннях клієнт перевіряє, чи не змінився ключ сервера. Це захист від атаки "людина посередині" (man-in-the-middle).

**Що станеться:**

1.  **Видалення ключів на ВМ:**
    ```bash
    sudo rm /etc/ssh/ssh_host_*_key*
    ```
2.  **Спроба НОВОГО підключення (до перезапуску sshd):**
    *   Підключення, скоріш за все, **не вдасться**, оскільки сервер `sshd`, що працює в пам'яті, не може знайти на диску свої файли ключів, які потрібні для встановлення з'єднання.
3.  **Перезапуск sshd на ВМ:**
    ```bash
    sudo systemctl restart sshd
    ```
    *   Під час перезапуску `sshd` виявить відсутність ключів хоста і **згенерує їх наново**. Це будуть вже **нові, інші** ключі.
4.  **Спроба НОВОГО підключення (після перезапуску sshd):**
    *   Ваш SSH-клієнт видасть **ВЕЛИКЕ ПОПЕРЕДЖЕННЯ**, щось на зразок `REMOTE HOST IDENTIFICATION HAS CHANGED!`.
    *   Це станеться тому, що ключ, який надав новий сервер, не співпадає з тим, що ваш клієнт зберіг у `~/.ssh/known_hosts` для цієї IP-адреси. Клієнт розцінює це як потенційну загрозу безпеці.

---

### 10. Відновлення можливості підключення

**Завдання:** Відновити можливість віддаленого підключення до ВМ.

**Пояснення:**
Щоб виправити помилку з попереднього кроку, потрібно сказати вашому SSH-клієнту "забути" старий ключ сервера.

**Дії (на клієнтській машині):**

1.  **Видалити старий запис про ключ:**
    *   У повідомленні про помилку буде вказано, з якого файлу (`~/.ssh/known_hosts`) і в якому рядку потрібно видалити запис.
    *   Найпростіший спосіб — виконати команду, яку запропонує сам `ssh`:
    ```bash
    ssh-keygen -R <IP_АДРЕСА_ВМ>
    ```
    Ця команда автоматично видалить потрібний ключ із `~/.ssh/known_hosts`.

2.  **Підключитися знову:**
    ```bash
    ssh vm
    ```
    Тепер клієнт поводитиметься так, ніби він підключається до цього сервера вперше: знову запитає, чи довіряєте ви новому ключу, і після вашого `yes` підключення пройде успішно.

---

## ВАЖЛИВЕ ПОПЕРЕДЖЕННЯ: Робота з існуючими SSH-ключами

Якщо ви вже маєте налаштовані SSH-ключі для доступу до інших серверів і виконуєте команду `ssh-keygen` без уваги, можливі два важливі сценарії:

### Сценарій 1: Перезапис існуючих ключів

Якщо `ssh-keygen` виявить, що файли `~/.ssh/id_rsa` та `~/.ssh/id_rsa.pub` вже існують, вона запитає:

```
/home/user/.ssh/id_rsa already exists.
Overwrite (y/n)?
```

**Якщо ви відповіли `y` (так):**
1.  **Старі ключі видалено:** Ваші попередні приватний (`id_rsa`) та публічний (`id_rsa.pub`) ключі були **безповоротно видалені**.
2.  **Створено нову пару:** На їх місці було згенеровано абсолютно нову пару ключів.
3.  **Втрачено доступ до старих серверів:** Оскільки старий публічний ключ (який лежав на інших серверах у файлі `authorized_keys`) більше не відповідає вашому новому приватному ключу, **ви втратите безпарольний доступ до всіх серверів, які були налаштовані раніше.**
    *   При спробі підключитися до старого сервера (`ssh user@old_server`), він більше не розпізнає ваш ключ і **запитає пароль**.
    *   Щоб відновити безпарольний доступ, вам доведеться повторити процедуру копіювання вашого **нового** публічного ключа на всі ті сервери за допомогою `ssh-copy-id`.

### Сценарій 2: Збереження ключів під новим іменем

Якщо на запитання `Overwrite (y/n)?` ви відповіли `n` (ні), або якщо ви вказали інше ім'я файлу на першому кроці (`Enter file in which to save the key`), то **ваші старі ключі залишаться у безпеці.**

1.  **Створення ключів з новою назвою:** Ви могли зберегти нову пару ключів під іншим іменем, наприклад, `~/.ssh/id_rsa_vm`. У такому разі у вас в каталозі `~/.ssh/` буде кілька пар ключів:
    *   `id_rsa` та `id_rsa.pub` (старі, для доступу до інших серверів)
    *   `id_rsa_vm` та `id_rsa_vm.pub` (нові, для доступу до вашої ВМ)

2.  **Необхідність явно вказувати ключ:** Коли ви підключаєтесь, `ssh` за замовчуванням намагається використати ключ `~/.ssh/id_rsa`. Щоб використати інший ключ, вам потрібно явно вказати шлях до нього за допомогою прапора `-i`:

    ```bash
    # Ця команда використає новий ключ для підключення до ВМ
    ssh -i ~/.ssh/id_rsa_vm user@vm_ip

    # А ця команда, як і раніше, буде використовувати старий ключ
    ssh user@old_server
    ```

    Або ж ви можете налаштувати файл `~/.ssh/config`, щоб він автоматично використовував правильний ключ для кожного сервера:

    ```
    # Підключення до старих серверів
    Host old_server
        HostName old_server.com
        User user
        IdentityFile ~/.ssh/id_rsa

    # Підключення до вашої ВМ
    Host vm
        HostName <IP_АДРЕСА_ВМ>
        User <USER_VM>
        IdentityFile ~/.ssh/id_rsa_vm
    ```

**Висновок:** Завжди будьте уважні при генерації нових SSH-ключів, особливо якщо у вас вже є існуючі. Найкраща практика при роботі з кількома ключами — давати їм осмислені імена та керувати ними через конфігураційний файл `~/.ssh/config`.

---

### Додатково: Копіювання існуючої пари ключів на іншу машину

Іноді виникає потреба використовувати ту саму SSH-ідентичність (пару ключів) на кількох клієнтських машинах. Наприклад, якщо ви працюєте з робочого комп'ютера та домашнього ноутбука і хочете підключатися до тих самих серверів без необхідності додавати новий публічний ключ на кожен сервер.

**Увага:** Приватний ключ (`id_rsa`) є вашим секретом. Передавати його по незахищених каналах або зберігати у ненадійних місцях категорично не рекомендується. Використовуйте захищені методи, такі як `scp` (Secure Copy), для передачі.

**Послідовність дій:**

1.  **На першій машині (де ключі вже існують):**
    *   Безпечно скопіюйте **приватний** та **публічний** ключі на другу машину. Вам потрібно буде знати IP-адресу та ім'я користувача на другій машині.
    ```bash
    # Копіюємо приватний ключ
    scp ~/.ssh/id_rsa <USER_MACHINE2>@<IP_MACHINE2>:~/.ssh/

    # Копіюємо публічний ключ
    scp ~/.ssh/id_rsa.pub <USER_MACHINE2>@<IP_MACHINE2>:~/.ssh/
    ```
    *   Замініть `<USER_MACHINE2>` та `<IP_MACHINE2>` на відповідні дані другої машини. `scp` запитає пароль для користувача на другій машині.

2.  **На другій машині (куди скопіювали ключі):**
    *   **Найважливіший крок:** Встановіть правильні, безпечні права доступу для приватного ключа. SSH не буде використовувати ключ, якщо він доступний для читання іншим користувачам.
    ```bash
    chmod 600 ~/.ssh/id_rsa
    ```
    *   Також переконайтеся, що каталог `~/.ssh` має права `700`.
    ```bash
    chmod 700 ~/.ssh
    ```

Після цих дій ви зможете підключатися з другої машини до серверів, на яких налаштований ваш публічний ключ, так само, як ви це робили з першої машини.