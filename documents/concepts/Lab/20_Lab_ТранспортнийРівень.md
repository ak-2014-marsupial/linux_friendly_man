# Лабораторна робота: Аналіз транспортного рівня

## Частина 1: Налаштування та аналіз з'єднань

> **Мета роботи:** Навчитися використовувати утиліти `netstat` та `ss` для аналізу мережевих з'єднань, а також отримати практичні навички роботи з утилітою `nc` (netcat) для створення простих клієнт-серверних взаємодій на транспортному рівні.

### 1. Перегляд стану мережевих з'єднань (до запуску сервера)

**Завдання:** Переглянути стан мережевих з'єднань хоста 1-ї ВМ.

**Команди:**
```bash
# Варіант 1: Використання netstat (застаріла утиліта)
netstat -tulnp

# Варіант 2: Використання ss (сучасна заміна netstat)
ss -tulnp
```

**Очікуваний вивід (приклад):**
```
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1234/sshd           
tcp6       0      0 :::22                   :::*                    LISTEN      1234/sshd
```

**Пояснення:**

На цьому етапі ми бачимо лише стандартні сервіси, які прослуховують порти.
*   **`ss` та `netstat`** — це утиліти для моніторингу мережевих сокетів (з'єднань). `ss` є більш сучасною та швидкою.
*   **Прапори `-tulnp`** означають:
    *   `-t`: Показати TCP-сокети.
    *   `-u`: Показати UDP-сокети.
    *   `-l`: Показати тільки прослуховуючі (LISTEN) сокети, тобто сервери, що очікують на з'єднання.
    *   `-n`: Не перетворювати IP-адреси та номери портів у доменні імена та назви сервісів (це прискорює виконання).
    *   `-p`: Показати процес (PID та ім'я), який використовує сокет.
*   **Результат:** Єдиний сервіс, що прослуховує з'єднання — це `sshd` (SSH-сервер) на порту `22`, який очікує на вхідні підключення для віддаленого керування. Адреса `0.0.0.0` (для IPv4) та `:::` (для IPv6) означають, що з'єднання приймаються на всіх мережевих інтерфейсах машини.

---

### 2. Запуск TCP-сервера на порту 5555

**Завдання:** Запустити на своїй віртуальній машині (ВМ1) сервер повідомлень.

**Команда:**
```bash
nc -kl 5555
```

**Пояснення:**

Ця команда запускає простий TCP-сервер за допомогою утиліти `nc` (netcat).
*   `nc` — це "швейцарський ніж" для роботи з мережею, що дозволяє читати та писати дані через TCP/UDP з'єднання.
*   `-l` (listen): Переводить `nc` у режим слухача (сервера).
*   `-k` (keep-alive): Змушує сервер продовжувати слухати порт навіть після того, як клієнт від'єднався. Без цього прапора сервер би завершив роботу після першого ж клієнта.
*   `5555`: Номер порту, який буде прослуховуватися. Це непривілейований порт (вище 1024), тому для його використання не потрібні права суперкористувача.

Після запуску команди термінал "зависне" — це очікувана поведінка, оскільки сервер працює і чекає на вхідні підключення.

---

### 3. Повторний перегляд стану мережевих з'єднань

**Завдання:** Переглянути стан мережевих з'єднань хоста 1-ї ВМ після запуску сервера `nc`.

**Команда:**
```bash
ss -tulnp
```

**Очікуваний вивід (приклад):**
```
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1234/sshd
tcp        0      0 0.0.0.0:5555            0.0.0.0:*               LISTEN      5678/nc             
tcp6       0      0 :::22                   :::*                    LISTEN      1234/sshd
tcp6       0      0 :::5555                 :::*                    LISTEN      5678/nc
```

**Пояснення:**

У порівнянні з першим пунктом, у виводі з'явився новий запис. Тепер, крім `sshd`, ми бачимо процес `nc`, який прослуховує порт `5555` для протоколів TCP (IPv4 та IPv6). Це підтверджує, що наш сервер успішно запущений і готовий приймати клієнтів.

---

### 4. Підключення клієнта до сервера

**Завдання:** Підключитись з 2-ї ВМ на 1-шу ВМ.

**Команда (виконується на ВМ2):**
```bash
nc <IP_АДРЕСА_ВМ1> 5555
```
> Замініть `<IP_АДРЕСА_ВМ1>` на реальну IP-адресу першої віртуальної машини.

**Пояснення:**

На другій машині ми запускаємо `nc` в режимі клієнта. Команда не має прапора `-l`, тому `nc` намагається підключитися до вказаної IP-адреси та порту. Після успішного встановлення з'єднання обидва термінали (на ВМ1 і ВМ2) будуть готові до обміну даними.

---

### 5. Передача повідомлень

**Завдання:** Передати повідомлення.

**Дії:**
1.  У терміналі ВМ2 (клієнт) введіть текст, наприклад, `Привіт, сервере!` і натисніть Enter.
2.  Подивіться на термінал ВМ1 (сервер).

**Очікуваний результат:**
*   На екрані ВМ1 з'явиться текст `Привіт, сервере!`.
*   Якщо після цього ввести текст у терміналі ВМ1 (наприклад, `Вітаю, клієнте!`) і натиснути Enter, цей текст з'явиться на екрані ВМ2.

**Пояснення:**
Це демонструє роботу двостороннього TCP-з'єднання. Все, що вводиться на одній стороні, передається через мережу і виводиться на іншій, і навпаки. Це базовий принцип роботи чатів, месенджерів та багатьох інших мережевих програм.

---

### 6. Спроба запуску сервера на привілейованому порту

**Завдання:** Виконати команду `nc -l 1000` на 1-й ВМ та зробити висновки.

**Команда:**
```bash
nc -l 1000
```

**Очікуваний вивід (помилка):**
```
nc: Permission denied
```

**Висновки та необхідні дії:**

*   **Висновок:** Команда завершилася з помилкою "Permission denied" (Відмовлено в доступі). Причина в тому, що порти в діапазоні від 0 до 1023 є **привілейованими**. Запускати сервіси на цих портах може лише суперкористувач (`root`).
*   **Необхідні дії:** Щоб команда спрацювала, її потрібно виконати з правами суперкористувача за допомогою `sudo`.
    ```bash
    sudo nc -l 1000
    ```
    Ця версія команди успішно запуститься.

---

### 7. Спроба зайняти вже використовуваний порт

**Завдання:** Виконати команду `nc -l 22` на 1-й ВМ та зробити висновки.

**Команда:**
```bash
sudo nc -l 22
```
> Ми одразу використовуємо `sudo`, оскільки порт `22` є привілейованим.

**Очікуваний вивід (помилка):**
```
nc: Address already in use
```

**Висновки:**
*   **Висновок:** Команда завершилася з помилкою "Address already in use" (Адреса вже використовується). Це сталося тому, що порт `22` вже зайнятий іншою програмою — сервером `sshd`, що ми бачили у виводі команди `ss` в першому пункті.
*   **Основне правило:** В один момент часу лише одна програма може "слухати" конкретний порт на конкретній IP-адресі. Неможливо запустити два сервери на одному й тому ж порту одночасно.

---

### 8. Підключення у зворотному напрямку

**Завдання:** Підключитись з 1-ї ВМ на 2-гу ВМ.

**Пояснення та послідовність дій:**

Процес є дзеркальним до того, що ми робили раніше. Щоб підключитися з ВМ1 до ВМ2, потрібно спочатку запустити сервер на ВМ2.

1.  **На ВМ2 запустіть сервер `nc`**, який буде чекати на з'єднання. Оберемо інший порт, наприклад, `5556`.
    ```bash
    # Команда для ВМ2
    nc -kl 5556
    ```

2.  **На ВМ1 запустіть клієнт `nc`**, який підключиться до сервера на ВМ2.
    ```bash
    # Команда для ВМ1
    nc <IP_АДРЕСА_ВМ2> 5556
    ```
    > Замініть `<IP_АДРЕСА_ВМ2>` на реальну IP-адресу другої віртуальної машини.

Після цього буде встановлено нове з'єднання, але тепер ВМ2 виступатиме в ролі сервера, а ВМ1 — в ролі клієнта.