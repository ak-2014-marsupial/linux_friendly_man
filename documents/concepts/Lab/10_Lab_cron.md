# Лабораторна робота №10: Робота з cron

## Створення користувацьких налаштувань cron

### 1. Перегляд журналу cron
Відкрийте нову вкладку `screen` (або `tmux`) і запустіть команду для інтерактивного перегляду системного журналу cron:
```bash
tail -f /var/log/cron
```
Ця команда дозволить вам бачити записи про виконання cron-задач у реальному часі.

### 2. Створення користувацької задачі cron
У новій вкладці `screen` (або `tmux`) відкрийте файл crontab поточного користувача для редагування:
```bash
crontab -e
```
Додайте наступний рядок у файл, щоб кожну хвилину записувати поточну дату до файлу `/tmp/date`:
```cron
* * * * * /bin/date >> /tmp/date 2>&1
```
*   `* * * * *`: Ця частина означає, що команда буде виконуватися кожну хвилину.
*   `/bin/date`: Команда, яка виводить поточну дату та час.
*   `>> /tmp/date`: Перенаправляє вивід команди `/bin/date` до файлу `/tmp/date`, додаючи його в кінець файлу.
*   `2>&1`: Перенаправляє стандартний потік помилок (stderr) у стандартний потік виводу (stdout), щоб будь-які помилки також записувалися у файл.

Збережіть та закрийте файл (зазвичай `Ctrl+x`, потім `Y`, потім `Enter` для `nano` або `:wq` для `vi`).

### 3. Перевірка наявності задачі cron
Після збереження задачі, ви можете перевірити її наявність у користувача за допомогою команди:
```bash
crontab -l
```
Ця команда виведе список усіх cron-задач, налаштованих для поточного користувача.

### 4. Перегляд вмісту журналу cron та файлів `/var/spool/cron/користувач`
*   **Журнал cron:** Поверніться до вкладки `screen`, де запущено `tail -f /var/log/cron`. Ви повинні побачити записи про виконання вашої нової задачі cron кожну хвилину.
*   **Файли crontab:** Користувацькі файли crontab зберігаються в директорії `/var/spool/cron/`. Ви можете переглянути вміст вашого файлу crontab за допомогою команди (замініть `<ваш_користувач>` на ім'я вашого користувача):
    ```bash
sudo cat /var/spool/cron/<ваш_користувач>
    ```

### 5. Інтерактивний перегляд файлу `/tmp/date`
Відкрийте ще одну вкладку `screen` (або `tmux`) і запустіть команду для інтерактивного перегляду файлу `/tmp/date`:
```bash
tail -f /tmp/date
```
Ви побачите, як файл оновлюється кожну хвилину з новою датою. Порівняйте ці оновлення з записами в журналі cron.

### 6. Зміна задачі cron на команду з помилкою
Відкрийте файл crontab для редагування знову:
```bash
crontab -e
```
Змініть рядок, замінивши команду `/bin/date` на `/bin/data` (яка, ймовірно, не існує):
```cron
* * * * * /bin/data >> /tmp/date 2>&1
```
Збережіть зміни. Через хвилину поверніться до вкладки з `tail -f /var/log/cron`. Ви повинні побачити повідомлення про помилку, що вказує на те, що команда `/bin/data` не знайдена або не може бути виконана. Це демонструє, як cron реєструє помилки виконання задач.

## Створення загальносистемних налаштувань cron

### 1. Очищення файлу `/tmp/date` кожні 20 хвилин
Відкрийте системний файл crontab для редагування. Для цього потрібні права суперкористувача:
```bash
sudo vi /etc/crontab
```
Додайте наступний рядок у кінець файлу:
```cron
0,20,40 * * * * root > /tmp/date
```
*   `0,20,40 * * * *`: Ця частина означає, що команда буде виконуватися на 0-й, 20-й та 40-й хвилині кожної години.
*   `root`: Вказує, що команда буде виконуватися від імені користувача `root`.
*   `> /tmp/date`: Перенаправляє порожній вивід (відсутність команди перед `>`) до файлу `/tmp/date`, ефективно очищаючи його.

Збережіть та закрийте файл.

### 2. Запуск команди `uptime` кожний робочий день о 9-00
Створіть новий файл crontab у директорії `/etc/cron.d/`. Це дозволяє створювати окремі файли для cron-задач, що спрощує їх організацію. Для цього потрібні права суперкористувача:
```bash
sudo vi /etc/cron.d/uptime
```
Додайте наступний вміст до файлу:
```cron
0 9 * * 1-5 root /usr/bin/uptime >> /tmp/uptime.log 2>&1
```
*   `0 9 * * 1-5`: Запускати о 9:00 ранку (0 хвилин, 9 годин) кожного дня з понеділка по п'ятницю (1-5).
*   `root`: Команда буде виконуватися від імені користувача `root`.
*   `/usr/bin/uptime`: Повний шлях до команди `uptime`, яка показує час роботи системи.
*   `>> /tmp/uptime.log 2>&1`: Додає вивід команди до файлу `/tmp/uptime.log`.

Збережіть та закрийте файл.

### 3. Підрахунок кількості редагувань налаштувань cron (загальна кількість)

Прямий підрахунок *редагувань* crontab за допомогою cron є складним, оскільки cron не має вбудованого механізму для цього. Зазвичай для такого моніторингу використовуються інші інструменти (наприклад, `inotify` або системи контролю версій). Однак, якщо завдання полягає в тому, щоб створити cron-задачу, яка *імітує* підрахунок або просто збільшує лічильник при кожному своєму запуску, можна зробити так:

1.  **Створіть скрипт**, наприклад, `/usr/local/bin/count_crontab_runs.sh`:
    ```bash
sudo vi /usr/local/bin/count_crontab_runs.sh
    ```
    Додайте наступний вміст:
    ```bash
#!/bin/bash
CRON_COUNT_FILE="/tmp/cron_count"

# Якщо файл лічильника не існує, створити його з нулем
if [ ! -f "$CRON_COUNT_FILE" ]; then
    echo 0 > "$CRON_COUNT_FILE"
fi

# Зчитати поточне значення, збільшити його та записати назад
CURRENT_COUNT=$(cat "$CRON_COUNT_FILE")
NEW_COUNT=$((CURRENT_COUNT + 1))
echo "$NEW_COUNT" > "$CRON_COUNT_FILE"
    ```
2.  **Зробіть скрипт виконуваним:**
    ```bash
sudo chmod +x /usr/local/bin/count_crontab_runs.sh
    ```
3.  **Додайте cron-задачу**, яка буде запускати цей скрипт (наприклад, щогодини) до `/etc/crontab` або `/etc/cron.d/`:
    ```bash
sudo vi /etc/crontab
    ```
    Додайте рядок:
    ```cron
0 * * * * root /usr/local/bin/count_crontab_runs.sh
    ```
    Ця задача буде запускатися щогодини і збільшувати лічильник у `/tmp/cron_count`. Зверніть увагу, що це рахує *запуски* цієї конкретної cron-задачі, а не фактичні *редагування* файлів crontab.

### 4. Підрахунок кількості редагувань налаштувань cron за поточну добу

Аналогічно попередньому пункту, для підрахунку за добу потрібен скрипт, який буде скидати лічильник щодня. Знову ж таки, це буде рахувати *запуски* задачі, а не *редагування*.

1.  **Створіть скрипт**, наприклад, `/usr/local/bin/count_daily_cron_runs.sh`:
    ```bash
sudo vi /usr/local/bin/count_daily_cron_runs.sh
    ```
    Додайте наступний вміст:
    ```bash
#!/bin/bash
CRON_DAILY_COUNT_FILE="/tmp/cron_daily_count"
LAST_RUN_DATE_FILE="/tmp/cron_daily_last_run_date"

CURRENT_DATE=$(date +%Y-%m-%d)

# Ініціалізація файлів, якщо вони не існують
if [ ! -f "$CRON_DAILY_COUNT_FILE" ] || [ ! -f "$LAST_RUN_DATE_FILE" ]; then
    echo 0 > "$CRON_DAILY_COUNT_FILE"
    echo "$CURRENT_DATE" > "$LAST_RUN_DATE_FILE"
fi

LAST_RUN_DATE=$(cat "$LAST_RUN_DATE_FILE")

# Якщо дата змінилася, скинути лічильник
if [ "$CURRENT_DATE" != "$LAST_RUN_DATE" ]; then
    echo 0 > "$CRON_DAILY_COUNT_FILE"
    echo "$CURRENT_DATE" > "$LAST_RUN_DATE_FILE"
fi

# Зчитати поточне значення, збільшити його та записати назад
CURRENT_COUNT=$(cat "$CRON_DAILY_COUNT_FILE")
NEW_COUNT=$((CURRENT_COUNT + 1))
echo "$NEW_COUNT" > "$CRON_DAILY_COUNT_FILE"
    ```
2.  **Зробіть скрипт виконуваним:**
    ```bash
sudo chmod +x /usr/local/bin/count_daily_cron_runs.sh
    ```
3.  **Додайте cron-задачу**, яка буде запускати цей скрипт (наприклад, щогодини) до `/etc/crontab` або `/etc/cron.d/`:
    ```bash
sudo vi /etc/crontab
    ```
    Додайте рядок:
    ```cron
0 * * * * root /usr/local/bin/count_daily_cron_runs.sh
    ```
    Ця задача буде запускатися щогодини, збільшуючи лічильник у `/tmp/cron_daily_count` і скидаючи його на початку нової доби. Знову ж таки, це рахує *запуски* цієї задачі, а не фактичні *редагування* файлів crontab.